<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="me.devking2106.useddeal.repository.mapper.BoardMapper">

    <resultMap id="BoardDetailDto" type="me.devking2106.useddeal.dto.BoardDetailDto">
        <result property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="nickname" column="nickname"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="locationName" column="location_name"/>
        <result property="price" column="price"/>
        <result property="categoryId" column="category_id"/>
        <result property="status" column="status"/>
        <result property="boardDate" column="board_date"/>
        <result property="isPull" column="IS_PULL"/>
    </resultMap>

    <insert id="save" parameterType="me.devking2106.useddeal.entity.Board" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO BOARD
        SET USER_ID = #{userId},
            LOCATION_NAME = #{locationName},
            LOCATION_ID = #{locationId},
            TITLE = #{title},
            CONTENT = #{content},
            PRICE = #{price},
            CATEGORY_ID = #{categoryId},
            STATUS = #{status},
            REG_DATE = #{regDate},
            MOD_DATE = #{modDate},
            BOARD_DATE = #{boardDate},
            IS_PULL = #{isPull},
            LATITUDE = #{latitude},
            LONGITUDE = #{longitude}
    </insert>

    <select id="findById" resultMap="BoardDetailDto">
        SELECT BOARD.ID,
               BOARD.USER_ID,
               USER.NICKNAME,
               BOARD.TITLE,
               BOARD.CONTENT,
               BOARD.LOCATION_NAME,
               BOARD.PRICE,
               BOARD.CATEGORY_ID,
               BOARD.STATUS,
               BOARD.BOARD_DATE,
               BOARD.IS_PULL
        FROM BOARD,
             USER
        WHERE BOARD.USER_ID = USER.ID
          AND BOARD.ID = #{id}
    </select>

    <select id="findByUser" resultType="me.devking2106.useddeal.dto.BoardFindDto">
        SELECT ID,
        TITLE,
        LOCATION_NAME,
        PRICE,
        CATEGORY_ID,
        STATUS,
        BOARD_DATE,
        IS_PULL
        FROM BOARD
        WHERE USER_ID = #{userId}
        <if test="userId != userIdResult">
            AND STATUS != 'HIDE'
        </if>
        ORDER BY BOARD_DATE
    </select>
    <select id="findAll" resultType="me.devking2106.useddeal.dto.BoardFindDto">
        SELECT ID,
        TITLE,
        LOCATION_NAME,
        PRICE,
        CATEGORY_ID,
        STATUS,
        BOARD_DATE,
        IS_PULL
        <if test="boardFindRequest.range == 0">
            FROM BOARD
            WHERE LOCATION_NAME = #{boardFindRequest.location}
        </if>
        <if test="boardFindRequest.range != 0">
            FROM (SELECT *,
            (6371*acos(cos(radians(#{latitude}))*cos(radians(LATITUDE))*cos(radians(LONGITUDE)-radians(#{longitude}))+sin(radians(#{latitude}))*sin(radians(LATITUDE))))
            AS distance
            FROM BOARD) BOARD
            WHERE DISTANCE <![CDATA[<=]]> #{boardFindRequest.range}
        </if>
        AND STATUS != 'HIDE'
        <if test=' "TITLE".equalsIgnoreCase(boardFindRequest.filterType)'>
            AND TITLE LIKE '%${boardFindRequest.query}%'
        </if>
        <if test=' "CONTENT".equalsIgnoreCase(boardFindRequest.filterType)'>
            AND CONTENT LIKE '%${boardFindRequest.query}%'
        </if>
        ORDER BY BOARD_DATE
    </select>

    <update id="updateStatus" keyProperty="id">
        UPDATE BOARD
        <if test=' "PULL".equalsIgnoreCase(status)'>
            SET IS_PULL = 1,
            MOD_DATE = #{updateTime},
            BOARD_DATE = #{updateTime}
            WHERE ID = (SELECT ID
            FROM (SELECT BOARD.ID,
            TIMESTAMPDIFF(SECOND, BOARD_DATE, NOW()) AS TIMESTAMPDIFF
            FROM BOARD, USER
            WHERE BOARD.USER_ID = USER.ID
            AND BOARD.ID = #{id}
            AND USER.ID = #{userId})
            WHERE TIMESTAMPDIFF > 172800)
        </if>
        <if test='!"PULL".equalsIgnoreCase(status)'>
            SET STATUS = #{status},
            MOD_DATE = #{updateTime}
            WHERE ID = (SELECT BOARD.ID
            FROM BOARD,
            USER
            WHERE BOARD.USER_ID = USER.ID
            AND BOARD.ID = #{id}
            AND USER.ID = #{userId})
        </if>
    </update>

    <update id="updateBoard" keyProperty="id">
        UPDATE BOARD
        SET MOD_DATE    = #{updateTime},
            TITLE       = #{boardModifyDto.title},
            CONTENT     = #{boardModifyDto.content},
            PRICE       = #{boardModifyDto.price},
            CATEGORY_ID = #{boardModifyDto.categoryId}
        WHERE ID = #{id}
    </update>

    <delete id="deleteById">
        DELETE
        FROM BOARD
        WHERE ID = #{id}
    </delete>

</mapper>
